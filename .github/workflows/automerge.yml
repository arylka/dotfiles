name: Auto-merge all device branches

on:
  push:
    branches:
    - "device/cerebro"

permissions:
  contents: "write"

jobs:
  sync:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 0
      - name: "Update device branches"
        shell: "bash"
        run: |
          set -eEuo pipefail
          main="$(git rev-parse --abbrev-ref HEAD)"
          echo "Main branch: $main"
          git pull origin
          for branch in "$(git for-each-ref --format='%(refname:short)' refs/heads/device/)"
          do
            if test "$branch" != "$main"
            then
              git checkout "$branch"
              echo "Checked out branch: $branch"
              git merge "$main"
              echo "Merged $main branch into $branch"
              git push origin "$branch"
              echo "Pushed $branch"
            fi
          done
          echo "All device branches updated"
